name: Buildroot for NanoPC-T4 (RK3399)

on:
  workflow_dispatch:    # 允许手动触发

env:
  SDK_DIR: linuxsdk-friendlyelec  # SDK 目录
  OUTPUT_DIR: images-output       # 输出目录

jobs:
  build:
    runs-on: ubuntu-22.04         # 使用 Ubuntu 22.04 构建环境

    steps:
         # 步骤 1: 安装必要的宿主机工具和依赖项（优化版）
      - name: Install host dependencies
        run: |
          sudo apt-get update
          
          # 先安装基础构建工具和编译依赖
          sudo apt-get install -y build-essential autoconf automake libtool make cmake
          sudo apt-get install -y gcc g++ gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          sudo apt-get install -y binutils curl wget git python3 python3-pip
          
          # 安装嵌入式开发特定工具
          sudo apt-get install -y device-tree-compiler u-boot-tools
          sudo apt-get install -y mtools parted libudev-dev libusb-1.0-0-dev
          
          # 安装库依赖
          sudo apt-get install -y libncurses-dev libssl-dev libdrm-dev
          sudo apt-get install -y zlib1g-dev libbz2-dev liblz4-tool
          sudo apt-get install -y texinfo genext2fs bc rsync file
          
          # 安装 repo 工具（用于 FriendlyARM SDK）
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo 'export PATH="$HOME/bin:$PATH"' >> ~/.bashrc
          source ~/.bashrc
          
          # 注意：我们跳过了 git-gui 和 gitk，因为它们不是构建必需的
          # 并且会导致版本冲突
              # 安装和设置 repo 工具
              
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH
      
          # 验证安装
          which repo || echo "repo not found in PATH"
          ls -la ~/bin/repo || echo "repo file not downloaded"
          ~/bin/repo --version || echo "cannot execute repo"
          
          echo "依赖安装完成"

      # 步骤 2: 初始化 FriendlyARM 的 Buildroot SDK (使用 repo 工具)
      - name: Initialize FriendlyARM SDK with repo
        run: |
          mkdir -p ${{ env.SDK_DIR }}
          cd ${{ env.SDK_DIR }}
          # 初始化 repo 清单，指定 RK3399 的 manifest
          repo init -u https://github.com/friendlyarm/buildroot_manifests \
            -b master -m rk3399_linux_release.xml \
            --repo-url=https://github.com/rockchip-linux/repo --no-clone-bundle
          # 开始同步代码库，使用循环以应对网络中断
          until repo sync -c --no-clone-bundle -j$(nproc); do
            echo "Repo sync failed, retrying in 10 seconds..."
            sleep 10
          done

      # 步骤 3: (可选) 在这里添加任何自定义步骤，例如替换设备树文件 (DTS)
      # - name: Apply custom DTS (example)
      #   run: |
      #     cd ${{ env.SDK_DIR }}
      #     cp /path/to/your/custom.dts kernel/arch/arm64/boot/dts/rockchip/your-custom.dts
      #   if: always() # 或者根据需要设置条件

      # 步骤 4: 执行构建 - 使用 FriendlyARM 提供的 build.sh 脚本
      - name: Build images using FriendlyARM build.sh
        run: |
          cd ${{ env.SDK_DIR }}
          # 授予脚本执行权限
          chmod +x build.sh
          # 构建所有组件 (u-boot, kernel, rootfs) 并生成 SD 卡镜像
          # 你可以根据需要修改目标，例如 ./build.sh kernel 只编译内核
          ./build.sh sd-img 2>&1 | tee build.log

      # 步骤 5: 收集构建产物
      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nanopc-t4-buildroot-images
          path: |
            ${{ env.SDK_DIR }}/rockdev/*.img
            ${{ env.SDK_DIR }}/build.log
          retention-days: 7

