name: Test RK3399 DTS Compilation

on:
  workflow_dispatch:

jobs:
  test-dts:
    runs-on: ubuntu-latest

    steps:
    # Checkout the current repository (containing dts/rk3399-nanopi4-rev00.dts)
    - name: Checkout current repository
      uses: actions/checkout@v4
      with:
        path: current-repo

    # Install dependencies
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y device-tree-compiler

    # Check for custom DTS file existence
    - name: Check custom DTS file existence
      run: |
        if [ ! -f current-repo/dts/rk3399-nanopi4-rev00.dts ]; then
          echo "Error: Custom DTS file 'current-repo/dts/rk3399-nanopi4-rev00.dts' not found."
          exit 1
        fi

    # Compile custom DTS
    - name: Compile custom rk3399-nanopi4-rev00.dts
      run: |
        dtc -I dts -O dtb -o current-repo/dts/rk3399-nanopi4-rev00.dtb \
          current-repo/dts/rk3399-nanopi4-rev00.dts
        if [ $? -eq 0 ]; then
          echo "DTS compilation successful: rk3399-nanopi4-rev00.dtb generated."
        else
          echo "DTS compilation failed."
          exit 1
        fi

    # Upload compiled DTB as artifact
    - name: Upload DTB artifact
      uses: actions/upload-artifact@v4
      with:
        name: rk3399-nanopi4-rev00-dtb
        path: current-repo/dts/rk3399-nanopi4-rev00.dtb
        retention-days: 7
